<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Merge reader."><title>storage::read::merge - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-e5308b57e507db71.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../../../static.files/light-d59023bfa12059d2.css"><link rel="stylesheet" disabled href="../../../static.files/dark-1ca41bb1e10af075.css"><link rel="stylesheet" disabled href="../../../static.files/ayu-18b4181a2f3fb862.css"><script src="../../../static.files/storage-3891ce972e3a2bf8.js"></script><script defer src="../../../static.files/main-98a684e84ae5b08b.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../storage/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../storage/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module merge</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#opaque-types">Opaque Types</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">storage</a>::<wbr><a href="../index.html">read</a>::<wbr><a class="mod" href="#">merge</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/storage/read/merge.rs.html#15-828">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Merge reader.</p>
<p>The implementation of <a href="struct.MergeReader.html" title="struct storage::read::merge::MergeReader"><code>MergeReader</code></a> is inspired by
<a href="https://github.com/apache/kudu/blob/9021f275824faa2bdfe699786957c40c219697c1/src/kudu/common/generic_iterators.cc#L107"><code>kudu's MergeIterator</code></a>
and <a href="https://github.com/CeresDB/ceresdb/blob/02a7e3100f47cf16aa6c245ed529a6978be20fbd/analytic_engine/src/row_iter/merge.rs"><code>CeresDB's MergeIterator</code></a></p>
<p>The main idea of the merge algorithm is to maintain a <code>merge window</code>. The window describes,
at any given time, the key range where we expect to find the row with the smallest key.
A <a href="struct.Node.html" title="struct storage::read::merge::Node"><code>Node</code></a> (known as the sub-iterator in kudu) whose NEXT overlaps with the <code>merge window</code>
is said to be actively participating in the merge.</p>
<p>The <code>merge window</code> is defined as follows:</p>
<ol>
<li>The window’s start is the smallest lower bound of all nodes. We
refer to the node that owns this lower bound as LOW.</li>
<li>The window’s end is the smallest upper bound of all nodes whose
lower bounds are less than or equal to LOW’s upper bound.
2a. The window’s end could be LOW’s upper bound itself, if it is the smallest
upper bound, but this isn’t necessarily the case.</li>
<li>The merge window’s dimensions change as the merge proceeds, though it
only ever moves “to the right” (i.e. the window start/end only increase).</li>
</ol>
<p>We can divide the nodes into two sets, one for whose next rows overlap with the <code>merge window</code>,
another for whose next rows do not. The merge steady state resembles that of a traditional
heap-based merge: the top-most node is popped from HOT, the lower bound is copied to the output
and advanced, and the node is pushed back to HOT.</p>
<p>In the steady state, we need to move nodes from COLD to HOT whenever the end of the merge window
moves; that’s a sign that the window may now overlap with a NEXT belonging to a nodes in the
second set (COLD). The end of the merge window moves when a node is fully exhausted (i.e. all rows have
been copied to the output), or when a node finishes its NEXT and needs to peek again.</p>
<p>At any given time, the NEXT belonging to the top-most node in COLD is nearest the merge window.
When the merge window’s end has moved and we need to refill HOT, the top-most node in COLD is
the best candidate. To figure out whether it should be moved, we compare its NEXT’s lower bound
against the upper bound in HOT’s first node: if the lower bound is less than or equal to the key,
we move the node from COLD to HOT. On the flip side, when a node from HOT finishes its NEXT and peeks
again, we also need to check whether it has exited the merge window. The approach is similar: if
its NEXT’s lower bound is greater than the upper bound of HOT’S first node, it’s time to move it to COLD.</p>
<p>A full description of the merge algorithm could be found in <a href="https://github.com/apache/kudu/blob/9021f275824faa2bdfe699786957c40c219697c1/src/kudu/common/generic_iterators.cc#L349"><code>kudu's comment</code></a>
and the <a href="https://docs.google.com/document/d/1uP0ubjM6ulnKVCRrXtwT_dqrTWjF9tlFSRk0JN2e_O0/edit#">google doc</a>.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.BatchCursor.html" title="struct storage::read::merge::BatchCursor">BatchCursor</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">A <code>BatchCursor</code> wraps the <code>Batch</code> and allows reading the <code>Batch</code> by row.</div></li><li><div class="item-name"><a class="struct" href="struct.MergeReader.html" title="struct storage::read::merge::MergeReader">MergeReader</a></div><div class="desc docblock-short">A reader that would sort and merge <code>Batch</code> from multiple sources by key.</div></li><li><div class="item-name"><a class="struct" href="struct.MergeReaderBuilder.html" title="struct storage::read::merge::MergeReaderBuilder">MergeReaderBuilder</a></div></li><li><div class="item-name"><a class="struct" href="struct.Node.html" title="struct storage::read::merge::Node">Node</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">A <code>Node</code> represent an individual input data source to be merged.</div></li><li><div class="item-name"><a class="struct" href="struct.RowCursor.html" title="struct storage::read::merge::RowCursor">RowCursor</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Reference to a row in <a href="struct.BatchCursor.html" title="struct storage::read::merge::BatchCursor">BatchCursor</a>.</div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Source.html" title="enum storage::read::merge::Source">Source</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Batch data source.</div></li></ul><h2 id="opaque-types" class="small-section-header"><a href="#opaque-types">Opaque Types</a></h2><ul class="item-table"><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="opaque" href="opaque..html" title="opaque storage::read::merge::"></a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="storage" data-themes="" data-resource-suffix="" data-rustdoc-version="1.69.0-nightly (34e6673a0 2023-02-25)" data-search-js="search-14421e1532aead08.js" data-settings-js="settings-f0c5c39777a9a2f6.js" data-settings-css="settings-0bcba95ff279c1db.css" ></div></body></html>